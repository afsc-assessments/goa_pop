---
title: "POP Parallel SS Model"
output: html_notebook
---

```{r}
# remotes::install_github("r4ss/r4ss")
require(ggplot2)
require(r4ss)
require(dplyr)
require(here)
require(reshape2)
theme_set(theme_minimal())
```

```{r}
## load in derived quants from previous model for comparisons
mod21 <- read.csv(here('2023','data','output','2021_derived_quants.csv'))
mod21$value <- as.numeric(gsub(',','',mod21$value))
```

# Initial builds
Models 100.01 to .04 include all the data and the ageing error matrix.
M and h are both fixed in the model but there is no prior.
```{r}
mod100_01 <- SS_output(here('2023','ss','v-100.04'))

SSplotData(mod100_01)
SSplotBiology(mod100_01, subplots = c(1,5,9))
SSplotIndices(mod100_01, subplots = 2)
SSplotTimeseries(mod100_01,subplot = 1)
SSplotTimeseries(mod100_01, subplot = 11)
SSplotRecdevs(mod100_01, subplots = 1)
SSplotComps(mod100_01,kind = 'LEN')
SSplotComps(mod100_01,kind = 'AGE')
SSplotSelex(mod100_01)

SSplotAgeMatrix(mod100_01, option =2 )

SSplotTimeseries(mod100_01,subplot = 7)
compdf<- mod100_01$timeseries%>% filter(Era == 'TIME')  %>% select(Yr, SpawnBio) %>%
  melt(., id = 'Yr') %>% 
  mutate(source = 'SS mod') %>%
  bind_rows(., mod21 %>% 
              filter(VARIABLE == 'SPAWNBIO') %>%
              select(Yr = YEAR, value ) %>% 
              mutate(source = '2021 Assessment'))

ggplot(compdf, aes(x = Yr, y = value, color = source)) +
  geom_line()

```
 
 Before tackling the prior & steepness issues I also want to get into selex.
 Realized there were some data wts on v100.04 so removed those.
 General philosophy is I am not trying to do a perfect bridge here; rather I am going to create something that seeems
 plausible, then can piecewise test major model differences (estimating q vs analyitcal, nat M, rec-dev treatment).

Selex at age. Length selex off.

Fish selex has four time blocks with varying functional forms.
Survey selex is asymptotic and non time varying. 
I used a double normal and simply locked up the terminal values.
Per the base par file, survey pars associated with "srv 1"
are # a50_srv1: 5.39748301693
# delta_srv1: 5.72319662062
I used the SS selex excel sheet to eyeball this, then pasted the resultant par values and free only p1, p3.
I updated the phases as well. The start-logit was bounded between 2 and 29 but this could theoretically get estimated.

```{r}
mod100_05 <- SS_output(here('2023','ss','v-100.05'))
SSplotSelex(mod100_05)
SS_plots(mod100_05)
```

Then I updated the WAA parameters and maturity parameters based on the last assessment. 
The age at 50% maturity is 9.5
None of these are estimated in the model.
But all growth pars are; I also constrained the VB pars somewhat since the curve was discontinuous.
I think the settlement age should be 2.
The log_mean_rec in the original is 4.43, somehwat akin to R0, so updated that INIT


 
```{r}
mod100_06 <- SS_output(here('2023','ss','v-100.06'))
SSplotBiology(mod100_06, subplots = c(1))
SSplotBiology(mod100_06, subplots = c(5))
SSplotBiology(mod100_06, subplots = c(9))
SSplotSelex(mod100_06, subplots =4)
SS_plots(mod100_06)
```

For 100.07 I introduced time blocking for the fishery selex.
This is done by introducing a line for each of four timeblocks x 3 estiamted pars per time block.
For these guys I'm estimating ps 1,4,6 since we have true domes; none of these curves line up perfectly 
KIM the SS syntax is that we are assigning it block DESIGN 2 with block function 2 (replace with pars).

The selex doesn't actually vary a ton across these blocks, and interestingly none want to actually do the dome.

```{r}
mod100_08 <- SS_output(here('2023','ss','v-100.08'))
SS_plots(mod100_08)
```

For mod_09 I switch q to be analytical and re-constrain R0 to be no more than 12.
I also updated the prior information for M to icnlude the fishlife prior as a normal.
Then I turn on estimation of M, fixing steepness at 0.95.
To deal with some warnings I had to update some par bounds
and update the age post settlement to 1.
This is the first time the scale is in line between the models.

I also realized that the maturity p2 was supposed to be logged, so instead of 0.66 used -0.4 for the slope.
```{r}
mod100_09 <- r4ss::SS_output(here('2023','ss','v-100.09'))
SS_plots(mod100_09)

mod09sb <- mod100_09$derived_quants[grep('SSB_',mod100_09$derived_quants$Label),] %>%  
mutate(variable = 'SpawnBio',
source = 'SS mod',Yr = as.numeric(substr(Label,5,9)),
lwr = Value-1.96*StdDev, upr = Value+1.96*StdDev) %>% 
filter(!is.na(Yr)) %>%
select(Yr, variable, value =Value, lwr, upr, source)


compdf<- 
  bind_rows(mod09sb %>% select(-lwr,-upr), mod21 %>% 
              filter(VARIABLE == 'SPAWNBIO') %>%
              select(Yr = YEAR,variable=VARIABLE, value ) %>% 
              mutate(source = '2021 Assessment'))

ggplot(subset(compdf, Yr > 1978), aes(x = Yr, y = value, color = source, fill = source)) +
  geom_line(lwd = 1.1) +
  scale_fill_manual(values = c('grey','seagreen')) +
  scale_color_manual(values = c('grey','seagreen')) +
  geom_ribbon(data=subset(mod09sb, Yr > 1978),aes(ymin = lwr, ymax = upr), alpha = 0.2)


  ggsave(last_plot(), 
  file = here('2023','ss','v-100.09','compare_ssb.png'),
  height = 4, width = 6, unit = 'in')


mod100_09$derived_quants[grep('SSB_unfished',mod100_09$derived_quants$Label),] 

mod100_09$timeseries %>% select(Yr, Bio_all, SpawnBio)

## run the M profiles on this model
## copy stuff to new folder, change control to control_modified, update starter
## to point theere and include prior likes
m.vec = seq(0.02,0.15,0.01); Nprofile = length(m.vec)
dir_prof = here('2023','ss','v-100.09-natMprofile')

r4ss::profile(dir_prof,
profilevec =m.vec , 
string ='NatM', show_in_console = TRUE)


profilemodels <- r4ss::SSgetoutput(dirvec = dir_prof, keyvec = 1:Nprofile)
profilesummary <-  r4ss::SSsummarize(profilemodels)

png(paste0(dir_prof,'/piner_plot_age.png'))
r4ss::PinerPlot(profilesummary, 
                legendloc = 'topleft',
                component = 'Age_like',
                 main = "Changes in age-composition likelihoods by fleet",
                profile.string = "NatM",profile.label = "Natural Mortality (M)")
dev.off()

 r4ss::SSplotProfile(profilesummary, # summary object
 profile.string = "NatM", # substring of profile parameter
profile.label = "Natural Mortality (M)",
plotdir = dir_prof, print = TRUE)


```
Need to ask Pete whether that whacky spike in the beginning is true for the 2021 model as well.

I want to investigate some behavior using this model. These include some CIE questions but I think the behavior is close enough we can compare.
Separately, I set fleet to -1 for the early fishery length comps. This fits the survey slightly better but changes the mgmt status.
Separately, I allow h to be estimated. This doesn't change much.
Separately, I start the model in 1975. This changes the scale drastically
```{r}
moddirs <- dir(here('2023','ss'), pattern =  '100.09', full.names = TRUE)[c(1,2,4)] 
biglist <- lapply(moddirs, SS_output) %>% r4ss::SSsummarize()
SSplotComparisons(biglist, print = T, plotdir = here('2023','ss','v-100.09'), legendlabels =basename(moddirs))
```

For model 100_10 I ghosted in the survey length comps,
updated the settlement age 1 1 (line 18 of control): reading the ss manual there isn't a way for recruits to be age 2.
they are always age 1. now the syntax ensures that spawning happens in may and those count as age-1 recruits next year.
just keep this in mind when interpreting the devs plot. this did away with the settle warning.
updated the settle age to 2 (line 52 of ctl, to deal with warning)

The model wants a realistic r0 of around 9.9.

```{r}
mod100_10 <- r4ss::SS_output(here('2023','ss','v-100.10'))
SS_plots(mod100_10)
```

I now want to see if we can get convergence to improve by simpifying
the selectivity. Though there is a good historical justificaiton to investigate the time blocks,
the derived curves are really not so distinct:
```{r}
knitr::include_graphics("C:/Users/maia.kapur/Work/assessments/2023/GOA_POP/goa_pop/2023/ss/v-100.10/plots/sel11_timevary_surf_flt1sex1.png")
```
So for mod100_11 I am doing away with the time blocks on fishery selex (but still estimating 3 pars of the double N for the entire TS).
I didn't want to drastically revert everything so just changed the blk_fxn on the original double normal pars and commented out the timevary chunk.
This actually made the convergence worse and fit the survey data worse. So sticking with the timevarying selex as in v10.
```{r}
mod100_11 <- r4ss::SS_output(here('2023','ss','v-100.11'))
SS_plots(mod100_11)
```
What would aid convergence in this model? Let's explore some data weighting.
Doing 3 rounds of francis weights starting at mod100_10
The francis weights suggested downweight everything, particularly the ages (by a factor of >10!)
and the comps by a factor of three.
This enables the model to converge; survey fits are still meh and it basically just reduced the comp fits.
It also broadens the uncertainty in the timeseries.
```{r}
## do this for two
r4ss::tune_comps(replist = mod100_10, fleets = 'all', 
niters_tuning = 2,
                                   dir = here('2023','ss','v-100.10-francis'),
                                   verbose = TRUE)
                               
mod100_10f <- r4ss::SS_output(here('2023','ss','v-100.10-Francis'))
SS_plots(mod100_10f)
mod100_10f$maximum_gradient_component
```

There are still some boundary issues so I will clear up the parameter spex then return to the data weighting as a final step.
The initial F is probably higher than the init at 0.008, and the range of Fs for init can also go to 4.
Looking at some bound warnings i reduced the p1 lwr for the survey selex to 1 (as it is for the fishery)
WRT growth it is silly to expect to model growth < 16cms when we have no obs at that time. so Lmin should be above 16.

It doesn't make sense to me that the total biomass is 1.3million t and the sb is ~1 million t. Something is amiss with the sex ratio.
Try sex setup = -1 ; things brings things inline but obviously depletion is still lower,
```{r}
mod100_12 <- r4ss::SS_output(here('2023','ss','v-100.12'))
SS_plots(mod100_12)
mod100_12$maximum_gradient_component<=1e-4 ## might not be fixed yet cause no weighting here
```
As before, tuning deals with the convergence issue.
By looking at the F plot, the main difference here is that the SS model thinks the population was pretty trashed
by the 1960s catches, such that the F values peak in the 1970s (whereas in the ADMB model they bump but don't exceed 1960s levels).
This to me suggests the protective assumption implied by the dome shaped selex. So some exploration of locking up the terminal parameter 
for the fishery selex in a dome will be informative about what's going on here. My suspicion is that this will throw the M estimate out of whack.
```{r}
r4ss::tune_comps(replist = mod100_12, fleets = 'all', 
niters_tuning = 3,
                                   dir = here('2023','ss','v-100.12-francis'),
                                   verbose = TRUE)
                               

mod100_12f <- r4ss::SS_output(here('2023','ss','v-100.12-francis'))
SS_plots(mod100_12f)
mod100_12f$maximum_gradient_component<=1e-4  
```